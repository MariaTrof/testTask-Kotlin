"use strict";

var constants_1 = require('./constants');
var find_changes_1 = require('./find-changes');
exports.diffingMiddleware = function (_ref, protocol) {
    var keys = _ref.keys;
    var skipVersion = _ref.skipVersion;
    return function (store) {
        return function (next) {
            return function (action) {
                var oldState = store.getState();
                var returnValue = next(action);
                var newState = store.getState();
                var updates = find_changes_1.findVersionedChanges(newState, oldState, keys);
                if (updates.length) {
                    protocol.sendToStoreClients({
                        type: constants_1.dispatchAction,
                        payload: Object.assign({ payload: updates }, constants_1.actions.updateSyncedState)
                    });
                }
                return returnValue;
            };
        };
    };
};
exports.trackRehydrationMiddleware = function (_ref2, protocol) {
    var waitForAction = _ref2.waitForAction;
    return function (store) {
        return function (next) {
            if (!waitForAction) {
                protocol.setRehydrationCompleted();
                protocol.maybeCheckVersion();
            }
            return function (action) {
                if (waitForAction && action.type === waitForAction) {
                    protocol.setRehydrationCompleted();
                    protocol.maybeCheckVersion();
                }
                return next(action);
            };
        };
    };
};